<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Match Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-firestore-compat.min.js"></script>
    <style>
        :root {
            --primary: #3a86ff;
            --secondary: #ff006e;
            --success: #38b000;
            --warning: #ffbe0b;
            --danger: #ff006e;
            --dark: #1a1a2e;
            --light: #f8f9fa;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--dark);
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            flex: 1;
        }
        
        header {
            background-color: var(--primary);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 0.5rem;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: var(--dark);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background-color: var(--primary);
            color: white;
        }
        
        .home-page {
            text-align: center;
            padding: 3rem 1rem;
        }
        
        .home-page h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }
        
        .home-page p {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .game-container {
            display: flex;
            flex-direction: column;
            margin: 1rem 0;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .game-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 1rem;
            gap: 0.5rem;
        }
        
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }
        
        .card.selected {
            border-color: var(--primary);
            background-color: rgba(58, 134, 255, 0.1);
        }
        
        .card.matched {
            border-color: var(--success);
            background-color: rgba(56, 176, 0, 0.1);
            cursor: default;
        }
        
        .filter-menu {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            padding: 1rem;
            position: absolute;
            top: 120px;
            right: 20px;
            z-index: 10;
            width: 300px;
            max-width: 90vw;
        }
        
        .filter-menu h3 {
            margin-bottom: 1rem;
            color: var(--primary);
        }
        
        .filter-group {
            margin-bottom: 1rem;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        
        .letter-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-bottom: 1rem;
        }
        
        .letter-btn {
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--primary);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .letter-btn.selected {
            background-color: var(--primary);
            color: white;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            padding: 2rem;
            width: 500px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .modal-header h2 {
            color: var(--primary);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--danger);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .summary-page {
            text-align: center;
            padding: 2rem 1rem;
        }
        
        .summary-card {
            background-color: white;
            border-radius: 8px;
            padding: 2rem;
            margin: 2rem auto;
            max-width: 600px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .summary-stat {
            font-size: 1.2rem;
            margin: 1rem 0;
            display: flex;
            justify-content: space-between;
        }
        
        .summary-stat-value {
            font-weight: bold;
            color: var(--primary);
        }
        
        .menu-icon {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--primary);
        }
        
        .hidden {
            display: none;
        }
        
        .flex {
            display: flex;
        }
        
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 4px;
        }
        
        .dropdown-content a {
            color: var(--dark);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            cursor: pointer;
        }
        
        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }
        
        .show {
            display: block;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header>
        <h1>Word Match Game</h1>
    </header>
    
    <div class="container" id="app-container">
        <!-- Content will be loaded here -->
        <div class="loader"></div>
    </div>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            // Replace with your Firebase config
            apiKey: "AIzaSyDfc0p67p2ZG1aB5XYgT8WVyU3HzsQ0fO4",
  authDomain: "vocabspaced.firebaseapp.com",
  projectId: "vocabspaced",
  storageBucket: "vocabspaced.firebasestorage.app",
  messagingSenderId: "625582802046",
  appId: "1:625582802046:web:bd8a55a39733da0ea6042f"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // App State
        const state = {
            currentPage: 'home',
            gameMode: null,
            gameData: [],
            filteredData: [],
            selectedCards: [],
            matchedPairs: [],
            gameStartTime: null,
            gameEndTime: null,
            gameStats: {
                totalPairs: 0,
                matchedPairs: 0,
                attempts: 0,
                wrongAttempts: 0,
                timeTaken: 0
            },
            timer: null,
            timeElapsed: 0,
            filters: {
                level: 'all',
                letters: [],
                markedOnly: false,
                frequentlyWrong: false,
                random: false,
                pairCount: 10
            },
            showFilterMenu: false,
            editWordId: null
        };
        
        // DOM Elements
        const appContainer = document.getElementById('app-container');
        
        // Render Functions
        function renderHomePage() {
            appContainer.innerHTML = `
                <div class="home-page">
                    <h1>Word Match Challenge</h1>
                    <p>Test your vocabulary by matching words with their meanings. Track your progress, challenge yourself with different difficulty levels, and improve your language skills!</p>
                    <button class="btn btn-primary" id="start-game-btn">Start Game</button>
                    <a href="https://sscchele.github.io/voc02/" target="_blank" class="btn btn-outline">Review Vocabulary</a>
                </div>
            `;
            
            document.getElementById('start-game-btn').addEventListener('click', startGame);
        }
        
        function renderGamePage() {
            appContainer.innerHTML = `
                <div class="game-container">
                    <div class="game-header">
                        <div class="timer">Time: 0s</div>
                        <div class="dropdown">
                            <button class="menu-icon" id="menu-btn">⋮</button>
                            <div class="dropdown-content" id="dropdown-menu">
                                <a id="filter-btn">Filters</a>
                                <a id="shuffle-btn">Shuffle</a>
                                <a id="end-game-btn">End Game</a>
                                <a id="restart-btn">Restart</a>
                            </div>
                        </div>
                    </div>
                    
                    <div id="filter-menu" class="filter-menu hidden">
                        <h3>Filter Options</h3>
                        
                        <div class="filter-group">
                            <label>Difficulty Level:</label>
                            <select id="level-filter" class="form-control">
                                <option value="all">All Levels</option>
                                <option value="easy">Easy</option>
                                <option value="moderate">Moderate</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Starting Letter:</label>
                            <div class="letter-filter" id="letter-filter">
                                ${generateLetterButtons()}
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <input type="checkbox" id="marked-filter" class="form-check">
                            <label for="marked-filter">Marked Words Only</label>
                        </div>
                        
                        <div class="filter-group">
                            <input type="checkbox" id="wrong-filter" class="form-check">
                            <label for="wrong-filter">Frequently Wrong</label>
                        </div>
                        
                        <div class="filter-group">
                            <input type="checkbox" id="random-filter" class="form-check">
                            <label for="random-filter">Random Words</label>
                        </div>
                        
                        <div class="filter-group">
                            <label>Number of Pairs:</label>
                            <select id="pair-count-filter" class="form-control">
                                <option value="5">5 Words</option>
                                <option value="10" selected>10 Words</option>
                                <option value="15">15 Words</option>
                                <option value="20">20 Words</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-primary" id="apply-filters-btn">Apply Filters</button>
                        <button class="btn btn-outline" id="close-filter-btn">Close</button>
                    </div>
                    
                    <div class="card-container" id="cards-container">
                        <!-- Cards will be loaded here -->
                        <div class="loader"></div>
                    </div>
                </div>
            `;
            
            // Add event listeners
            document.getElementById('menu-btn').addEventListener('click', toggleDropdown);
            document.getElementById('filter-btn').addEventListener('click', toggleFilterMenu);
            document.getElementById('shuffle-btn').addEventListener('click', shuffleCards);
            document.getElementById('end-game-btn').addEventListener('click', endGame);
            document.getElementById('restart-btn').addEventListener('click', restartGame);
            document.getElementById('apply-filters-btn').addEventListener('click', applyFilters);
            document.getElementById('close-filter-btn').addEventListener('click', toggleFilterMenu);
            
            // Letter filter buttons
            const letterButtons = document.querySelectorAll('.letter-btn');
            letterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.classList.toggle('selected');
                    const letter = btn.dataset.letter;
                    if (btn.classList.contains('selected')) {
                        if (!state.filters.letters.includes(letter)) {
                            state.filters.letters.push(letter);
                        }
                    } else {
                        state.filters.letters = state.filters.letters.filter(l => l !== letter);
                    }
                });
            });
            
            // Other filter controls
            document.getElementById('level-filter').addEventListener('change', (e) => {
                state.filters.level = e.target.value;
            });
            
            document.getElementById('marked-filter').addEventListener('change', (e) => {
                state.filters.markedOnly = e.target.checked;
            });
            
            document.getElementById('wrong-filter').addEventListener('change', (e) => {
                state.filters.frequentlyWrong = e.target.checked;
            });
            
            document.getElementById('random-filter').addEventListener('change', (e) => {
                state.filters.random = e.target.checked;
            });
            
            document.getElementById('pair-count-filter').addEventListener('change', (e) => {
                state.filters.pairCount = parseInt(e.target.value);
            });
            
            // Update filter UI to match state
            updateFilterUI();
            
            // Start timer
            startTimer();
            
            // Load and render cards
            fetchAndRenderCards();
        }
        
        function renderSummaryPage() {
            const { totalPairs, matchedPairs, attempts, wrongAttempts, timeTaken } = state.gameStats;
            const accuracy = attempts > 0 ? Math.round((matchedPairs * 2 / attempts) * 100) : 0;
            
            appContainer.innerHTML = `
                <div class="summary-page">
                    <h2>Game Summary</h2>
                    
                    <div class="summary-card">
                        <div class="summary-stat">
                            <span>Score:</span>
                            <span class="summary-stat-value">${matchedPairs}/${totalPairs} pairs matched</span>
                        </div>
                        
                        <div class="summary-stat">
                            <span>Accuracy:</span>
                            <span class="summary-stat-value">${accuracy}%</span>
                        </div>
                        
                        <div class="summary-stat">
                            <span>Time Taken:</span>
                            <span class="summary-stat-value">${formatTime(timeTaken)}</span>
                        </div>
                        
                        <div class="summary-stat">
                            <span>Total Attempts:</span>
                            <span class="summary-stat-value">${attempts}</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" id="play-again-btn">Play Again</button>
                    <button class="btn btn-outline" id="go-home-btn">Go Home</button>
                </div>
            `;
            
            document.getElementById('play-again-btn').addEventListener('click', startGame);
            document.getElementById('go-home-btn').addEventListener('click', () => {
                state.currentPage = 'home';
                renderApp();
            });
        }
        
        function renderEditWordModal(wordData) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'edit-modal';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>${wordData.id ? 'Edit Word' : 'Add New Word'}</h2>
                        <button class="close-btn" id="close-modal-btn">&times;</button>
                    </div>
                    
                    <form id="edit-word-form">
                        <div class="form-group">
                            <label for="word-input">Word:</label>
                            <input type="text" id="word-input" class="form-control" value="${wordData.word || ''}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="meaning-input">Meaning:</label>
                            <textarea id="meaning-input" class="form-control" rows="3" required>${wordData.meaning || ''}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="synonyms-input">Synonyms (comma separated):</label>
                            <input type="text" id="synonyms-input" class="form-control" value="${wordData.synonyms?.join(', ') || ''}">
                        </div>
                        
                        <div class="form-group">
                            <label for="antonyms-input">Antonyms (comma separated):</label>
                            <input type="text" id="antonyms-input" class="form-control" value="${wordData.antonyms?.join(', ') || ''}">
                        </div>
                        
                        <div class="form-group">
                            <label for="wrong-options-input">Wrong Options (comma separated):</label>
                            <input type="text" id="wrong-options-input" class="form-control" value="${wordData.wrongOptions?.join(', ') || ''}">
                        </div>
                        
                        <div class="form-group">
                            <label for="level-input">Difficulty Level:</label>
                            <select id="level-input" class="form-control">
                                <option value="easy" ${wordData.level === 'easy' ? 'selected' : ''}>Easy</option>
                                <option value="moderate" ${wordData.level === 'moderate' ? 'selected' : ''}>Moderate</option>
                                <option value="hard" ${wordData.level === 'hard' || !wordData.level ? 'selected' : ''}>Hard</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <input type="checkbox" id="marked-input" ${wordData.marked ? 'checked' : ''}>
                            <label for="marked-input">Mark this word</label>
                        </div>
                        
                        <div class="form-group">
                            <label for="wrong-count-input">Wrong Count:</label>
                            <input type="number" id="wrong-count-input" class="form-control" value="${wordData.wrongCount || 0}" min="0">
                        </div>
                        
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">${wordData.id ? 'Save Changes' : 'Add Word'}</button>
                            ${wordData.id ? '<button type="button" class="btn btn-danger" id="delete-word-btn">Delete Word</button>' : ''}
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('close-modal-btn').addEventListener('click', () => {
                modal.remove();
            });
            
            document.getElementById('edit-word-form').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const updatedWordData = {
                    word: document.getElementById('word-input').value,
                    meaning: document.getElementById('meaning-input').value,
                    synonyms: document.getElementById('synonyms-input').value.split(',').map(s => s.trim()).filter(s => s),
                    antonyms: document.getElementById('antonyms-input').value.split(',').map(s => s.trim()).filter(s => s),
                    wrongOptions: document.getElementById('wrong-options-input').value.split(',').map(s => s.trim()).filter(s => s),
                    level: document.getElementById('level-input').value,
                    marked: document.getElementById('marked-input').checked,
                    wrongCount: parseInt(document.getElementById('wrong-count-input').value) || 0,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (wordData.id) {
                    // Update existing word
                    db.collection('words').doc(wordData.id).update(updatedWordData)
                        .then(() => {
                            modal.remove();
                            fetchAndRenderCards();
                        })
                        .catch(error => {
                            console.error("Error updating word: ", error);
                            alert("Error updating word. Please try again.");
                        });
                } else {
                    // Add new word
                    updatedWordData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    
                    db.collection('words').add(updatedWordData)
                        .then(() => {
                            modal.remove();
                            fetchAndRenderCards();
                        })
                        .catch(error => {
                            console.error("Error adding word: ", error);
                            alert("Error adding word. Please try again.");
                        });
                }
            });
            
            if (wordData.id) {
                document.getElementById('delete-word-btn').addEventListener('click', () => {
                    if (confirm("Are you sure you want to delete this word?")) {
                        db.collection('words').doc(wordData.id).delete()
                            .then(() => {
                                modal.remove();
                                fetchAndRenderCards();
                            })
                            .catch(error => {
                                console.error("Error deleting word: ", error);
                                alert("Error deleting word. Please try again.");
                            });
                    }
                });
            }
        }
        
        // Helper Functions
        function generateLetterButtons() {
            let buttons = '';
            for (let i = 65; i <= 90; i++) {
                const letter = String.fromCharCode(i);
                buttons += `<div class="letter-btn" data-letter="${letter}">${letter}</div>`;
            }
            return buttons;
        }
        
        function toggleDropdown() {
            document.getElementById('dropdown-menu').classList.toggle('show');
        }
        
        function toggleFilterMenu() {
            state.showFilterMenu = !state.showFilterMenu;
            document.getElementById('filter-menu').classList.toggle('hidden', !state.showFilterMenu);
            document.getElementById('dropdown-menu').classList.remove('show');
        }
        
        function updateFilterUI() {
            // Level
            document.getElementById('level-filter').value = state.filters.level;
            
            // Letters
            const letterButtons = document.querySelectorAll('.letter-btn');
            letterButtons.forEach(btn => {
                const letter = btn.dataset.letter;
                btn.classList.toggle('selected', state.filters.letters.includes(letter));
            });
            
            // Other filters
            document.getElementById('marked-filter').checked = state.filters.markedOnly;
            document.getElementById('wrong-filter').checked = state.filters.frequentlyWrong;
            document.getElementById('random-filter').checked = state.filters.random;
            document.getElementById('pair-count-filter').value = state.filters.pairCount.toString();
        }
        
        function startTimer() {
            // Clear any existing timer
            if (state.timer) {
                clearInterval(state.timer);
            }
            
            state.timeElapsed = 0;
            state.gameStartTime = new Date();
            
            const timerElement = document.querySelector('.timer');
            
            state.timer = setInterval(() => {
                state.timeElapsed++;
                timerElement.textContent = `Time: ${formatTime(state.timeElapsed)}`;
            }, 1000);
        }
        
        function stopTimer() {
            if (state.timer) {
                clearInterval(state.timer);
                state.timer = null;
                state.gameEndTime = new Date();
                state.gameStats.timeTaken = state.timeElapsed;
            }
        }
        
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        // Game Logic Functions
        function startGame() {
            state.currentPage = 'game';
            state.selectedCards = [];
            state.matchedPairs = [];
            state.gameStats = {
                totalPairs: 0,
                matchedPairs: 0,
                attempts: 0,
                wrongAttempts: 0,
                timeTaken: 0
            };
            renderApp();
        }
        
        function endGame() {
            stopTimer();
            state.currentPage = 'summary';
            renderApp();
        }
        
        function restartGame() {
            startGame();
        }
        
        function shuffleCards() {
            renderCards();
            document.getElementById('dropdown-menu').classList.remove('show');
        }
        
        function applyFilters() {
            toggleFilterMenu();
            fetchAndRenderCards();
        }
        
        function fetchAndRenderCards() {
            const cardsContainer = document.getElementById('cards-container');
            cardsContainer.innerHTML = '<div class="loader"></div>';
            
            let query = db.collection('words');
            
            // Apply level filter
            if (state.filters.level !== 'all') {
                query = query.where('level', '==', state.filters.level);
            }
            
            // Apply marked filter
            if (state.filters.markedOnly) {
                query = query.where('marked', '==', true);
            }
            
            // Apply frequently wrong filter
            if (state.filters.frequentlyWrong) {
                query = query.where('wrongCount', '>', 0).orderBy('wrongCount', 'desc');
            }
            
            // Fetch data
            query.get()
                .then(snapshot => {
                    state.gameData = [];
                    snapshot.forEach(doc => {
                        state.gameData.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    filterAndRenderCards();
                })
                .catch(error => {
                    console.error("Error fetching words: ", error);
                    cardsContainer.innerHTML = '<p>Error loading words. Please try again.</p>';
                });
        }
        
        function filterAndRenderCards() {
            let filteredWords = [...state.gameData];
            
            // Apply letter filter
            if (state.filters.letters.length > 0) {
                filteredWords = filteredWords.filter(word => {
                    const firstLetter = word.word.charAt(0).toUpperCase();
                    return state.filters.letters.includes(firstLetter);
                });
            }
            
            // If random is selected, shuffle the words
            if (state.filters.random) {
                filteredWords = shuffleArray(filteredWords);
            }
            
            // Limit to the number of pairs
            filteredWords = filteredWords.slice(0, state.filters.pairCount);
            
            // Store the filtered data
            state.filteredData = filteredWords;
            state.gameStats.totalPairs = filteredWords.length;
            
            // Render the cards
            renderCards();
        }
        
        function renderCards() {
            const cardsContainer = document.getElementById('cards-container');
            
            if (!state.filteredData || state.filteredData.length === 0) {
                cardsContainer.innerHTML = '<p>No words found with the current filters. Try different filters.</p>';
                return;
            }
            
            // Create an array of card objects
            let cards = [];
            
            // Add word cards
            state.filteredData.forEach(word => {
                cards.push({
                    id: word.id,
                    type: 'word',
                    content: word.word,
                    matchId: word.id
                });
            });
            
            // Add meaning cards
            state.filteredData.forEach(word => {
                cards.push({
                    id: word.id + '-meaning',
                    type: 'meaning',
                    content: word.meaning,
                    matchId: word.id
                });
            });
            
            // Shuffle the cards
            cards = shuffleArray(cards);
            
            // Render the cards
            cardsContainer.innerHTML = cards.map(card => {
                const isMatched = state.matchedPairs.includes(card.matchId);
                const isSelected = state.selectedCards.some(sc => sc.id === card.id);
                
                return `
                    <div class="card ${isMatched ? 'matched' : ''} ${isSelected ? 'selected' : ''}" 
                         data-id="${card.id}" 
                         data-type="${card.type}" 
                         data-match-id="${card.matchId}"
                         ${isMatched ? 'data-matched="true"' : ''}>
                        ${card.content}
                        ${card.type === 'word' && !isMatched ? 
                          `<div class="dropdown">
                              <button class="menu-icon card-menu-btn" data-word-id="${card.matchId}">⋮</button>
                              <div class="dropdown-content card-dropdown" data-dropdown-id="${card.matchId}">
                                  <a class="edit-word-btn" data-word-id="${card.matchId}">Edit</a>
                                  <a class="mark-word-btn" data-word-id="${card.matchId}">
                                      ${getWordById(card.matchId).marked ? 'Unmark' : 'Mark'}
                                  </a>
                              </div>
                           </div>` 
                          : ''}
                    </div>
                `;
            }).join('');
            
            // Add event listeners to cards
            const cardElements = document.querySelectorAll('.card');
            cardElements.forEach(card => {
                if (!card.dataset.matched) {
                    card.addEventListener('click', handleCardClick);
                }
            });
            
            // Add event listeners to card menu buttons
            const cardMenuBtns = document.querySelectorAll('.card-menu-btn');
            cardMenuBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleCardDropdown(btn.dataset.wordId);
                });
            });
            
            // Add event listeners to edit buttons
            const editBtns = document.querySelectorAll('.edit-word-btn');
            editBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const wordId = btn.dataset.wordId;
                    const wordData = getWordById(wordId);
                    renderEditWordModal(wordData);
                });
            });
            
            // Add event listeners to mark buttons
            const markBtns = document.querySelectorAll('.mark-word-btn');
            markBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const wordId = btn.dataset.wordId;
                    toggleMarkWord(wordId);
                });
            });
        }
        
        function toggleCardDropdown(wordId) {
            const dropdown = document.querySelector(`.card-dropdown[data-dropdown-id="${wordId}"]`);
            document.querySelectorAll('.card-dropdown').forEach(d => {
                if (d !== dropdown) {
                    d.classList.remove('show');
                }
            });
            dropdown.classList.toggle('show');
            
            // Close the dropdown when clicking outside
            document.addEventListener('click', function closeDropdown(e) {
                if (!e.target.matches('.card-menu-btn')) {
                    dropdown.classList.remove('show');
                    document.removeEventListener('click', closeDropdown);
                }
            });
            
            // Prevent the click from propagating to the card
            dropdown.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }
        
        function handleCardClick(e) {
            const card = e.currentTarget;
            
            // Ignore if the card is already matched or selected
            if (card.dataset.matched === 'true' || card.classList.contains('selected')) {
                return;
            }
            
            // Ignore if two cards are already selected
            if (state.selectedCards.length >= 2) {
                return;
            }
            
            // Select the card
            card.classList.add('selected');
            state.selectedCards.push({
                id: card.dataset.id,
                type: card.dataset.type,
                matchId: card.dataset.matchId
            });
            
            // Check for a match if two cards are selected
            if (state.selectedCards.length === 2) {
                state.gameStats.attempts++;
                
                setTimeout(() => {
                    checkForMatch();
                }, 1000);
            }
        }
        
        function checkForMatch() {
            const [card1, card2] = state.selectedCards;
            
            if (card1.matchId === card2.matchId && card1.type !== card2.type) {
                // It's a match!
                document.querySelector(`[data-id="${card1.id}"]`).classList.add('matched');
                document.querySelector(`[data-id="${card1.id}"]`).dataset.matched = 'true';
                document.querySelector(`[data-id="${card2.id}"]`).classList.add('matched');
                document.querySelector(`[data-id="${card2.id}"]`).dataset.matched = 'true';
                
                // Add to matched pairs
                if (!state.matchedPairs.includes(card1.matchId)) {
                    state.matchedPairs.push(card1.matchId);
                    state.gameStats.matchedPairs++;
                }
                
                // Check if all pairs are matched
                if (state.matchedPairs.length === state.filteredData.length) {
                    endGame();
                }
            } else {
                // Not a match
                document.querySelector(`[data-id="${card1.id}"]`).classList.remove('selected');
                document.querySelector(`[data-id="${card2.id}"]`).classList.remove('selected');
                
                state.gameStats.wrongAttempts++;
                
                // Increment wrong count for the word
                if (card1.type === 'word') {
                    incrementWrongCount(card1.matchId);
                } else if (card2.type === 'word') {
                    incrementWrongCount(card2.matchId);
                }
            }
            
            // Clear selected cards
            state.selectedCards = [];
        }
        
        function incrementWrongCount(wordId) {
            db.collection('words').doc(wordId).update({
                wrongCount: firebase.firestore.FieldValue.increment(1)
            }).catch(error => {
                console.error("Error updating wrong count: ", error);
            });
        }
        
        function toggleMarkWord(wordId) {
            const word = getWordById(wordId);
            
            db.collection('words').doc(wordId).update({
                marked: !word.marked
            }).then(() => {
                // Update the word in the state
                word.marked = !word.marked;
                
                // Update the mark button text
                const markBtn = document.querySelector(`.mark-word-btn[data-word-id="${wordId}"]`);
                markBtn.textContent = word.marked ? 'Unmark' : 'Mark';
                
                // Close the dropdown
                document.querySelector(`.card-dropdown[data-dropdown-id="${wordId}"]`).classList.remove('show');
            }).catch(error => {
                console.error("Error toggling mark: ", error);
                alert("Error marking word. Please try again.");
            });
        }
        
        function getWordById(id) {
            return state.filteredData.find(word => word.id === id) || {};
        }
        
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
        
        // Main App Render Function
        function renderApp() {
            switch (state.currentPage) {
                case 'home':
                    renderHomePage();
                    break;
                case 'game':
                    renderGamePage();
                    break;
                case 'summary':
                    renderSummaryPage();
                    break;
                default:
                    renderHomePage();
            }
        }
        
        // Handle clicks outside of dropdowns
        window.addEventListener('click', (e) => {
            if (!e.target.matches('.menu-icon')) {
                const dropdowns = document.getElementsByClassName('dropdown-content');
                for (let i = 0; i < dropdowns.length; i++) {
                    if (dropdowns[i].classList.contains('show')) {
                        dropdowns[i].classList.remove('show');
                    }
                }
            }
        });
        
        // Initialize the app
        renderApp();
    </script>
</body>
</html>
